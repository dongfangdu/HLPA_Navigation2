# -*- coding: utf-8 -*- 

"""
# @Description: 
# @Author: AlexRainHao<yuanyuhaoyyh@gamil.com> 
# @Copyright 2021 - 2021 
# @Date: 2021-03-25 14:19:57 
# @Version: __Dev__ 
"""

import streamlit as st
import pandas as pd
import requests
import json

_URL = "http://192.168.108.197:9999"
_STATUS = _URL + "/status"
_PARSER = _URL + "/model/parse"
_MLIST = _URL + "/model/list"
_MPUT = _URL + "/model/put"
_MINFO = _URL + "/model/info"

_LAB_MAPPING = {"[cls]": "é¢„è­¦", "[unk]": "æ­£å¸¸"}

def yunpan_classify():
    ''' pass '''

    # ===============
    # æ¦‚è¿°
    # ===============
    st.header("â™Ÿ æ¦‚è¿° â™Ÿ")
    st.markdown("äº‘ç›˜é¢„è­¦ï¼Œæ˜¯é’ˆå¯¹äº‘ç›˜äº§å“ç ”å‘çš„`åŸºäº NLP å­¦ä¹ `çš„æ™ºèƒ½æ–‡æœ¬æ•æ„Ÿæ£€æµ‹èƒ½åŠ›")
    st.markdown("è¯¥èƒ½åŠ›æ—¨åœ¨å¼±åŒ–ç°æœ‰äº§å“çš„ `è¯å…¸å¼ºåŒ¹é…` æ–¹æ³•ï¼Œé€šè¿‡ `ç¦»çº¿å­¦ä¹ ` æŒç»­åœ¨å®¢æˆ·æœ¬åœ°è¿›è¡Œæ¨¡å‹ä¼˜åŒ–")
    
    st.markdown("---")
    st.markdown("è¯•ç”¨æœåŠ¡ip: `192.168.108.197:9999`, å„ API è§ `API æ¥å£æ–‡æ¡£`")

    # ===============
    # æ ·ä¾‹ä½“éªŒ
    # ===============
    
    st.header("â™Ÿ æ ·ä¾‹ä½“éªŒ â™Ÿ")
    st.warning("ä½“éªŒç¯å¢ƒä¸ºæµ‹è¯•ç¯å¢ƒï¼Œè§£æå¯èƒ½å­˜åœ¨å»¶è¿Ÿ")
    
    try:
        requests.get(_STATUS)
    except:
        st.error("æœåŠ¡æœªå¼€å¯ï¼Œè¯·è”ç³»ASRåŸºç¡€ç ”å‘éƒ¨")
        
    default_sample = "å°½ç®¡ï¼Œæ³•è½®åŠŸï¼Œé‚ªæ•™ç»„ç»‡å®£ç§°èƒ½è®©å…¶ä¿¡å¾’ï¼ŒåŠŸæˆåœ†æ»¡ä½›é“ç¥ï¼Œé€šè¿‡ï¼Œç™½æ—¥é£å‡ï¼Œçš„æ–¹å¼è¿›å…¥æ‰€è°“çš„ï¼Œæ³•è½®ä¸–ç•Œï¼Œäº«å—æ°¸ä¸å¹²æ¶¸çš„ç¦æ³½ï¼Œç„¶è€Œä¸å¹¸çš„äº‹å®å´æ˜¯ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªçš„ï¼Œæ³•è½®åŠŸï¼Œéª¨å¹²å› ä¸ºç–¾ç—…ç­‰å„ç§åŸå› ç›¸ç»§ç¦»ä¸–ï¼Œç”šè‡³è¿ï¼Œæ³•è½®åŠŸï¼Œé‚ªæ•™ç»„ç»‡ä¸»ææ´ªå¿—çš„æ¯äº²ä¹Ÿå› ç—…å»ä¸–ï¼Œå‘½å½’é»„æ³‰ï¼Œå´ä»æœªè§ä¸€ä¸ªè¯¥é‚ªæ•™çš„ä¿¡å¾’ï¼Œç™½æ—¥é£å‡ï¼ŒåŠŸæˆåœ†æ»¡ä½›é“ç¥è°è¨€å°±æ˜¯è°è¨€ï¼Œçº¸åŒ…ä¸ä½ç«ï¼Œè°è¨€åœ¨äº‹å®é¢å‰ä¸å ªä¸€å‡»ã€‚"
    
    text = st.text_area("ğŸ„ è¯·è¾“å…¥ä½“éªŒæ–‡æœ¬:", value = default_sample, key="yunpan_cls_sample_parser")
    
    if st.button("ç‚¹å‡»è§£æ"):
        try:
            parser_res = requests.post(url = _PARSER, data = json.dumps({"text": text, "auto_split": True})).json()
            st.success("è§£æå®Œæˆ")
            
            sentences_res = parser_res["sentences"]
            for s in sentences_res:
                s["mapping"] = _LAB_MAPPING[s["intent"]]

            df = pd.DataFrame(
                sentences_res, columns=["order", "start","end", "text", "intent", "mapping", "prob"]
            )
            df.columns = ['åºå·', 'å¼€å§‹', 'ç»“æŸ', "æ–‡æœ¬", "ç±»åˆ«", "å¤‡æ³¨", "ç½®ä¿¡åº¦"]

            st.table(df)

        except:
            st.error("è§£æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")
            
    # ===============
    # API æ¥å£æ–‡æ¡£
    # ===============
    st.header("â™Ÿ API æ¥å£æ–‡æ¡£ â™Ÿ")
    if st.checkbox("ç‚¹å‡»æŸ¥çœ‹ æ¥å£æ–‡æ¡£"):
        st.write("æœåŠ¡é€šè¿‡ HTTP è¿›è¡ŒæœåŠ¡è§£æè¯·æ±‚\n")
        
        option = st.selectbox(
            "API é€‰æ‹©", (
                "æœåŠ¡çŠ¶æ€", "æ–‡æœ¬è§£æ", "åœ¨ç”¨æ¨¡å‹ä¿¡æ¯", "æ¨¡å‹åˆ—è¡¨", "æ›´æ¢æ¨¡å‹", "é”™è¯¯ç "
                )
            )
        
        # =====================
        if option == "æœåŠ¡çŠ¶æ€":
            st.subheader("ğŸ„ å…¥å‚ GET")
            st.table(pd.DataFrame({
                "è·¯ç”±": ["/status"],
                "è¯´æ˜": ["æœåŠ¡æ˜¯å¦å­˜æ´»"]
            }))
            
            st.subheader("ğŸ„ åå‚ JSON")
            st.json(
                {
                    "statue": 200,
                    "message": "successfully"
                }
            )
            
        # =====================
        elif option == "æ–‡æœ¬è§£æ":
            st.subheader("ğŸ„ å…¥å‚ POST/JSON")
            st.json({
                "text": "ä»Šå¤©æ­å·çš„å¤©æ°”æ€ä¹ˆæ ·",
                "auto_split": True
            })
            st.write("\n")
            st.table(pd.DataFrame({
                "å±æ€§": ["text", "auto_split"],
                "ç±»å‹": ["String", "Bool"],
                "è¯´æ˜": ["å¾…è§£ææ–‡æœ¬", "æ˜¯å¦é‡‡ç”¨é•¿æ–‡æœ¬åˆ†å‰²ï¼ˆå»ºè®®é‡‡ç”¨)"]
            }))
            st.table(pd.DataFrame({
                "è·¯ç”±": ["/model/parse"],
                "è¯´æ˜": ["è§£ææ–‡æœ¬æ˜¯å¦æ¶‰å¯†"]
            }))
            
            st.subheader("ğŸ„ åå‚ JSON")
            st.json({
                "task_id": "185693e61bc042a583f70a2944f516a3",
                "task_name": "rf",
                "sentences": [
                    {
                        "task_id": "185693e61bc042a583f70a2944f516a3",
                        "task_name": "rf",
                        "order": 0,
                        "sentence_id": "c3d3683dfd7347008c57d44cfb4052f3",
                        "start": 0,
                        "end": 200,
                        "time": "2021-03-25 15:07:34:511537",
                        "text": "ä»é—®é¢˜æœ¬èº«æ¥è®²ï¼Œè¿™æ ¹æœ¬å°±ä¸æ˜¯ä¸€ä¸ªæ³•å­¦è¯¾é¢˜ï¼Œè€Œæ˜¯ä¸€ä¸ªæ”¿æ²»å­¦çš„è¯¾é¢˜ï¼Œä¸å¯èƒ½åœ¨æ³•å­¦é¢†åŸŸæ‰¾åˆ°ç»“è®ºï¼Œä»ç°å®æ¥è®²ï¼Œç”±äºæˆ‘å›½å®ªæ³•è§„å®šäº†åšæŒä¸­å›½å…±äº§å…šçš„é¢†å¯¼ï¼Œå› æ­¤åå¯¹ä¸‰æƒåˆ†ç«‹ï¼Œå®ªæ”¿æ°‘ä¸»å’Œå¸æ³•ç‹¬ç«‹ï¼Œå°±æˆä¸ºæˆ‘å›½æ¯ä¸€ä¸ªå¸æ³•äººå‘˜åº”å°½çš„æ”¿æ²»ä¹‰åŠ¡å’Œå®ªæ³•ä¹‰åŠ¡åœ¨ä¸åŒæ”¿æ²»ä½“åˆ¶ä¸‹çš„å¸æ³•æœºæ„ï¼Œè™½ç„¶åå­—éƒ½å«æ³•é™¢ï¼Œä½†æ˜¯è¥¿æ–¹ä¸‰æƒåˆ†ç«‹ä¸‹çš„å¸æ³•æœºæ„ä¸æˆ‘å›½çš„å¸æ³•æœºæ„åœ¨èŒèƒ½ä¸Šæ˜¯ä¸å®Œå…¨ä¸€æ ·çš„ï¼Œç”šè‡³æœ‰å¾ˆå¤§å·®åˆ«ã€‚å®è¡Œï¼Œå®šæ‰¿åŠæ³•å®˜ï¼Œå®šåŠç†æ—¶é™ï¼Œå®šå·¥ä½œè´£ä»»ï¼Œ",
                        "intent": "[cls]",
                        "prob": 0.88
                    },
                    {
                        "task_id": "185693e61bc042a583f70a2944f516a3",
                        "task_name": "rf",
                        "order": 1,
                        "sentence_id": "f0e0c87907324111b57a735fd56d5759",
                        "start": 200,
                        "end": 349,
                        "time": "2021-03-25 15:07:34:511569",
                        "text": "å®šåŒ…æ¡ˆé¢†å¯¼ï¼Œå®è¡Œé™¢é•¿åŒ…æ¡ˆï¼Œçš„ï¼Œå››å®šä¸€åŒ…ï¼Œå·¥ä½œè´£ä»»åˆ¶ï¼Œå»ºç«‹åœå¿æ¡ˆä»¶å°è´¦ï¼Œèšç„¦è§£å†³é‡éš¾ç‚¹é—®é¢˜ä¸ºç¡®ä¿æ¡ˆä»¶å®¡æ‰§è´¨é‡ï¼Œå‰æ—çœé«˜é™¢æ‹Ÿåˆ¶ï¼Œé©»å‰å†›äº‹å•ä½åœå¿é¡¹ç›®å®Œæˆæ¸…é€€ç¡®è®¤ä¹¦ï¼Œä¸‹å‘å…¨çœæ³•é™¢ï¼Œæ˜ç¡®è¦æ±‚ç»æ³•é™¢å®¡åˆ¤æ‰§è¡Œçš„åœå¿é¡¹ç›®å®Œæˆæ¸…é€€çš„ï¼Œå¿…é¡»ç”±æ¡ˆæ¶‰å†›äº‹å•ä½é¢†å¯¼ç­¾å­—å¹¶ç›–ç« ç¡®è®¤ï¼Œç¡®ä¿äº†æ¯ä¸€é¡¹æ¶‰æ¡ˆåœå¿å·¥ä½œéƒ½å®Œæˆå¾—å¹²å‡€å½»åº•ã€‚",
                        "intent": "[unk]",
                        "prob": 0.6268904152144188
                    }
                ],
                "percentage": 0.500,
                "mean_prob": 0.627,
                "max_prob": 0.880,
                "min_prob": 0.373
            })
            
            st.write('\nå¤–å±‚å±æ€§')
            st.table(pd.DataFrame({
                "å±æ€§": ["task_name", "sentences", "percentage", "mean_prob", "max_prob", "min_prob"],
                "ç±»å‹": ["String", "List", "Float", "Float", "Float", "Float"],
                "è¯´æ˜": ["åœ¨ç”¨æ¨¡å‹åç§°", "å•å¥è§£æç»“æœ", "æ¶‰å¯†å¥å æ¯”", "å¹³å‡æ¶‰å¯†ç½®ä¿¡åº¦", "æœ€å¤§æ¶‰å¯†ç½®ä¿¡åº¦", "æœ€å°æ¶‰å¯†ç½®ä¿¡åº¦"]
            }))
            st.write('\nå†…å±‚å±æ€§')
            st.table(pd.DataFrame({
                "å±æ€§": ["order", "start", "end", "text", "intent", "prob"],
                "ç±»å‹": ["Int", "Int", "Int", "String", "String", "Float"],
                "è¯´æ˜": ["åºå·", "å•å¥åœ¨åŸä¸Šä¼ æ–‡æœ¬çš„å¼€å§‹ä½ç½®", "å•å¥åœ¨åŸä¸Šä¼ æ–‡æœ¬çš„ç»“æŸä½ç½®", "åˆ†å¥æ–‡æœ¬", "åˆ†ç±»ç»“æœ([cls]ä¸ºé¢„è­¦)", "æ‰€å±åˆ†ç±»ç»“æœç½®ä¿¡åº¦"]
            }))
        
        # =====================
        elif option == "åœ¨ç”¨æ¨¡å‹ä¿¡æ¯":
            st.subheader("ğŸ„ å…¥å‚ GET")
            st.table(pd.DataFrame({
                "è·¯ç”±": ["/model/info"],
                "è¯´æ˜": ["åœ¨ç”¨æ¨¡å‹ä¿¡æ¯"]
            }))
            
            st.subheader("ğŸ„ åå‚ JSON")
            st.json(
                {
                    "task_name": "rf",
                    "model_path": "/home/admin/models/rf"
                }
            )
            st.write("\n")
            st.table(pd.DataFrame({
                "å±æ€§": ["task_name", "model_path"],
                "ç±»å‹": ["String", "String"],
                "è¯´æ˜": ["æ¨¡å‹åç§°", "æ¨¡å‹è·¯å¾„"]
            }))
        
        # =====================
        elif option == "æ¨¡å‹åˆ—è¡¨":
            st.subheader("ğŸ„ å…¥å‚ GET")
            st.table(pd.DataFrame({
                "è·¯ç”±": ["/model/list"],
                "è¯´æ˜": ["æ‰€æœ‰å¯ç”¨æ¨¡å‹åç§°"]
            }))
            
            st.subheader("ğŸ„ åå‚ JSON")
            st.json(
                {
                    "task_list": ["rf", "nb"],
                }
            )
            st.write("\n")
            st.table(pd.DataFrame({
                "å±æ€§": ["task_list"],
                "ç±»å‹": ["List"],
                "è¯´æ˜": ["æ‰€æœ‰å¯ç”¨æ¨¡å‹åç§°"]
            }))            

        # =====================
        elif option == "æ›´æ¢æ¨¡å‹":
            st.subheader("ğŸ„ å…¥å‚ PUT/JSON")
            st.json({
                "task_name": "nb",
            })
            st.table(pd.DataFrame({
                "å±æ€§": ["task_name"],
                "ç±»å‹": ["String"],
                "è¯´æ˜": ["æ¨¡å‹åç§°"]
            }))
            st.table(pd.DataFrame({
                "è·¯ç”±": ["/model/put"],
                "è¯´æ˜": ["æ›´æ¢æœåŠ¡æ¨¡å‹"]
            }))
            
            
            st.subheader("ğŸ„ åå‚ JSON")
            {
                "statue": 200,
                "message": "successfully",
                "task_name": "nb",
                "model_path": "/home/admin/model/nb"
            }
            st.write("\n")
            st.table(pd.DataFrame({
                "å±æ€§": ["statue", "message", "task_name", "model_path"],
                "ç±»å‹": ["Int", "String", "String", "String"],
                "è¯´æ˜": ["çŠ¶æ€ç ", "çŠ¶æ€ä¿¡æ¯", "æ›¿æ¢åæ¨¡å‹åç§°", "æ›¿æ¢åæ¨¡å‹è·¯å¾„"]
            })) 
            
        # =====================
        elif option == "é”™è¯¯ç ":
            st.table(pd.DataFrame({
                "é”™è¯¯ç ": [400, 500],
            }))
            
    # ===============
    # éƒ¨ç½²æ–‡æ¡£
    # ===============
    st.header("â™Ÿ API éƒ¨ç½²æ–‡æ¡£ â™Ÿ")
    if st.checkbox("ç‚¹å‡»æŸ¥çœ‹ éƒ¨ç½²æ–‡æ¡£"):
        st.write("æœªå®Œæˆ\n")
        
    # ===============
    # éƒ¨ç½²æ–‡æ¡£
    # ===============
    st.header("â™Ÿ API æœªæ¥åŠŸèƒ½â™Ÿ")
    if st.checkbox("ç‚¹å‡»æŸ¥çœ‹ æœªæ¥åŠŸèƒ½â™Ÿ"):
        st.markdown("* æ¥å…¥æ•æ„Ÿè¯æ±‡æ¨¡å‹")
        st.markdown("* è‡ªå®šä¹‰ä¸Šä¼ æ•°æ®è¿›è¡Œè®­ç»ƒçš„æ¥å£")
        st.markdown("* çŠ¶æ€ç è§„æ•´ã€æ—¥å¿—è§„æ•´")
        st.markdown("* æ›´å¤šæ¨¡å‹")
        
        
        
if __name__ == "__main__":
    yunpan_classify()